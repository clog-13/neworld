# 如何用Elasticsearch构建商品搜索系统

## 理解倒排索引机制

搜索的核心需求是全文匹配，对于全文匹配，**数据库的索引是根本派不上用场的**，那只能全表扫描。全表扫描已经非常慢了，还需要在每条记录上做全文匹配，也就是一个字一个字的比对。

为了能够支持快速地全文搜索，ES 中对于文本采用了一种特殊的索引：倒排索引（Inverted Index）。倒排索引相比于一般数据库采用的 B 树索引，它的写入和更新性能都比较差，因此倒排索引也只是适合全文搜索，不适合更新频繁的交易类数据。思考题

## 思考题

- 我们在电商的搜索框中搜索商品时，它都有一个搜索提示的功能，比如我输入“苹果”还没有点击搜索按钮的时候，搜索框下面会提示“苹果手机”、“苹果 11、苹果电脑”这些建议的搜索关键字，请你课后看一下 ES 的文档，想一下，如何用 ES 快速地实现这个搜索提示功能？
  - 因为用户每输入一个字都可能会发请求查询搜索框中的搜索推荐。所以搜索推荐的请求量远高于搜索框中的搜索。es针对这种情况提供了 **suggestion api**，并提供的专门的数据结构应对搜索推荐，性能高于match，但它应用起来也有局限性，就是**只能做前缀匹配**。再结合pinyin分词器可以做到输入拼音字母就提示中文。如果想做非前缀匹配，可以考虑Ngram。不过Ngram有些复杂，需要开发者自定义分析器。
- 如果用 ES 做全文检索，需要把 title 的类型设置为 text，支持分词，这样就可以像老师在专栏中介绍的一样，用 “苹果手机”进行全文检索了。 但是如果要实现思考题这种前缀推荐，需要 title 的类型为 completion。 要想实现 title 既支持前缀推荐，又支持全文检索，但一个 field 只能设置一种类型，这种该怎么实现呢？
  - 一个字段可以加很多个field，针对不同field使用不同的搜索语句，比如title这个字段，我会先设置一个ik分词器的text类型，再设置一个默认standard的text类型的field，field取名就叫standard，再设置一个keyword类型的field，取名叫keyword。搜索的时候match去找title字段，match phrase去找title.standard，term去找title.keyword。不论设置多少个field给title，返回值只会有一个title。